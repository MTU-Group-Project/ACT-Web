<!DOCTYPE html>
<html lang="en">
    <head>
        <base href="/">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/style.css">
        <title>ACT REPORT {{ stockname }}</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    </head>
    <body>
        {% include "signedInHeader.html" %}
        <main>
            <h2>{{ stockname }}</h2>
            <div id="stockgraph">
                <canvas id="chart"></canvas>
            </div>
            <div>
                <a class="heroButton" onclick="generateAI()">Generate AI Report</a>
                <p id="aiStatus">Unrequested...</p>
                <p id="aiText"></p>
            </div>
        </main>
        <footer>
            <div class="footerBottom">
                <p>Copyright &copy;2023; Designed by <span class="designer">Nichita, Daniel, Alex, Wiktor</span></p>
            </div>
        </footer>
        <script>
            const stockHistory = {{ stockhistory|safe }};

            var i = 0;

            const openPrices = stockHistory.map(s => s.Open);
            const closePrices = stockHistory.map(s => s.Close);
            const labels = stockHistory.map(s => `${i--}`).reverse();

            const ctx = document.getElementById("chart").getContext("2d");

            const stockChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [
                        {
                            label: "OPEN Price",
                            data: openPrices,
                            borderColor: "rgba(75, 192, 192, 1)",
                            backgroundColor: "rgba(75, 192, 192, 0.2)",
                            borderWidth: 1
                        },
                        {
                            label: "CLOSE Price",
                            data: closePrices,
                            borderColor: "rgba(255, 99, 132, 1)",
                            backgroundColor: "rgba(255, 99, 132, 0.2)",
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "Days"
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: "Price (USD)"
                            }
                        }
                    }
                }
            });

            var interval = null;

            function generateAI() {

                var stock = "{{ stockname }}";
                
                // Make a call to start the request, but this fetch call is not useful
                //   after this point. Read Firebase to get the data instead
                fetch(`/api/startreport/${stock}`);

                if (interval != null)
                    clearInterval(interval);

                interval = setInterval(() => {
                    fetch(`/api/stockstatus/${stock}`).then(data => data.text()).then(data => {
                        document.querySelector("#aiStatus").textContent = `AI Report Status: ${data}`;
                    });

                    fetch(`/api/stockreport/${stock}`).then(data => data.text()).then(data => {
                        if (data != "")
                            clearInterval(interval);

                        document.querySelector("#aiText").innerHTML = marked.parse(data);
                    });
                }, 1000);
            }
        </script>
    </body>
</html>
